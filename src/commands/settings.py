import re

from telegram import InlineKeyboardMarkup, InlineKeyboardButton, Update
from telegram.ext import ConversationHandler, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, \
    filters

from src.config import Config
from src.crud.city import create_city, get_city_by_name
from src.crud.crypto_currency import get_crypto_by_user_id, get_crypto_by_abbr
from src.crud.currency import get_curr_by_user_id, get_curr_by_name
from src.crud.user import create_or_update_user, get_user_by_id, update_user
from src.handlers.canel_conversation import cancel, cancel_back_keyboard
from src.models.errors import CityFetchError
from src.utils.db_utils import get_session
from src.utils.message_utils import send_typing_action
from src.utils.time_utils import UserTime
from src.utils.weather_utils import OpenWeatherMapAPI, SinoptikScraper

SETTINGS_START, CITY_SETTINGS, TIMEZONE_SETTINGS, CRYPTO_SETTINGS, CURR_SETTINGS = 1, 2, 3, 4, 5

main_settings_keyboard = InlineKeyboardMarkup([
    [InlineKeyboardButton('–ú—ñ—Å—Ç–æ üèôÔ∏è', callback_data='city_settings')],
    [InlineKeyboardButton('–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å üåê', callback_data='timezone_settings')],
    [InlineKeyboardButton('–ö—Ä–∏–ø—Ç–æ –≤–∞–ª—é—Ç–∏ ü™ô', callback_data='crypto_settings')],
    [InlineKeyboardButton('–§—ñ–∞—Ç–Ω—ñ –≤–∞–ª—é—Ç–∏ üá∫üá¶', callback_data='curr_settings')],
    [InlineKeyboardButton('üö´ –í—ñ–¥–º—ñ–Ω–∏—Ç–∏', callback_data='cancel')]
], )


@send_typing_action
async def settings(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    message = update.message
    user = message.from_user
    context.user_data['command_msg'] = message

    async with get_session() as session:
        await create_or_update_user(session, user)

    settings_start_text = '–ë–∞–∂–∞—î—à –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —â–æ—Å—å?\n–û–±–µ—Ä–∏ –∑ –Ω–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–∏—Ö –æ–ø—Ü—ñ–π:'

    context.user_data['markup_msg'] = await message.reply_text(settings_start_text, reply_markup=main_settings_keyboard)

    return SETTINGS_START


async def back_to_settings(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    settings_start_text = '–®—É–∫–∞—î—à —â–æ—Å—å —ñ–Ω—à–µ?\n–û–±–µ—Ä–∏ –∑ –Ω–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–∏—Ö –æ–ø—Ü—ñ–π:'

    await query.edit_message_text(text=settings_start_text, reply_markup=main_settings_keyboard)

    return SETTINGS_START


async def city_settings_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    user = update.effective_user
    message = query.message
    await query.answer()

    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        users_city_model = user_model.city

    if users_city_model:
        city_change_text = (f'‚ö† –í —Ç–µ–±–µ —É–∂–µ –≤–∫–∞–∑–∞–Ω–µ –º—ñ—Å—Ç–æ - {users_city_model.local_name}. '
                            f'–¢–∏ —Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ—à –π–æ–≥–æ –∑–º—ñ–Ω–∏—Ç–∏?\n\n–î–ª—è –∑–º—ñ–Ω–∏ –Ω–∞–¥—ñ—à–ª–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ –∞–±–æ –ø—Ä—è–º–µ '
                            f'–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω—å–æ–≥–æ –∑ ua.sinoptik.ua —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ.')
    else:
        city_change_text = ('üÜó –û–±—Ä–∞–Ω–æ –∑–º—ñ–Ω—É –º—ñ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É –ø–æ–≥–æ–¥–∏.\n\n'
                            '–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ –∞–±–æ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω—å–æ–≥–æ –∑ ua.sinoptik.ua '
                            '—É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–µ.')

    context.user_data['markup_msg'] = await message.edit_text(text=city_change_text, reply_markup=cancel_back_keyboard)

    return CITY_SETTINGS


@send_typing_action
async def city_settings_change(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    message = update.message
    user = update.effective_user
    markup_msg = context.user_data['markup_msg']

    await markup_msg.edit_reply_markup(reply_markup=None)
    user_input = message.text.strip()

    try:
        if url := SinoptikScraper.check_url(user_input):
            city_name = re.sub(r'https://ua.sinoptik.ua/–ø–æ–≥–æ–¥–∞-', '', url)
            city_name_no_digits = re.sub(r'-\d+', '', city_name)
            city_data = OpenWeatherMapAPI.get_city(city_name_no_digits)
        else:
            city_data = OpenWeatherMapAPI.get_city(user_input)
    except CityFetchError:
        city_not_found_text = ('‚ö† C—Ö–æ–∂–µ –Ω–∞–∑–≤–∞ –º—ñ—Å—Ç–∞ –≤–∫–∞–∑–∞–Ω–∞ –Ω–µ –≤—ñ—Ä–Ω–æ(–∞–±–æ —è –¥—É—Ä–Ω–∏–π), –±–æ –Ω–µ –º–æ–∂—É –∑–Ω–∞–π—Ç–∏ —Ç–∞–∫–æ–≥–æ –º—ñ—Å—Ç–∞.'
                               '\n\n–°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –Ω–∏–∂—á–µ')

        context.user_data['markup_msg'] = await message.reply_text(city_not_found_text,
                                                                   reply_markup=cancel_back_keyboard,
                                                                   quote=True)
        return CITY_SETTINGS

    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        users_city_model = user_model.city

    city_name_local = city_data['local_name']
    city_name_eng = city_data['name']
    city_change_text = f'‚úÖ –ó—Ä–æ–±–ª–µ–Ω–æ, —Ç–≤–æ—î –º—ñ—Å—Ç–æ —Ç–µ–ø–µ—Ä - {city_name_local}.\n\n–©–æ—Å—å —â–µ?'

    if users_city_model and users_city_model.name == city_name_eng:
        city_change_text = '‚ùï –¢–∞–∫ —Ü–µ –∂ —Ç–µ —Å–∞–º–µ –º—ñ—Å—Ç–æ, –∂–æ–¥–Ω–∏—Ö –∑–º—ñ–Ω –Ω–µ –≤–Ω–æ—à—É üôÉ\n\n–©–æ—Å—å —â–µ?'

        await message.reply_text(city_change_text, reply_markup=main_settings_keyboard)
        return SETTINGS_START

    sinoptik_base_url = url if url else SinoptikScraper.get_url(city_name_local)
    city_timezone_offset = city_data['timezone_offset']

    async with get_session() as session:
        city_model = await get_city_by_name(session, city_name_eng)
        if not city_model:
            await create_city(session,
                              owm_id=city_data['id'],
                              name=city_name_eng,
                              local_name=city_name_local,
                              lat=city_data['lat'],
                              lon=city_data['lon'],
                              sinoptik_url=sinoptik_base_url,
                              timezone_offset=city_timezone_offset)

        city_model = await get_city_by_name(session, city_name_eng)

        await update_user(session, user, {'city_id': city_model.id})

    city_changed_message = await message.reply_text(city_change_text,
                                                    reply_to_message_id=message.message_id,
                                                    reply_markup=main_settings_keyboard)

    if city_timezone_offset and (city_timezone_offset != user_model.timezone_offset):
        city_change_text = city_change_text.replace('\n\n–©–æ—Å—å —â–µ?', '')
        city_change_text += '\n\n‚ùï –£ —Ç–µ–±–µ —ñ —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞ —Ä—ñ–∑–Ω—ñ —á–∞—Å–æ–≤—ñ –ø–æ—è—Å–∏, –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –º—ñ—Å—Ç—É —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å?'
        approve_keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(f'–ó–º—ñ–Ω–∏—Ç–∏ –Ω–∞ "{UserTime.offset_repr(city_timezone_offset)}"',
                                  callback_data='change_to_city')],
            [InlineKeyboardButton('–î–µ—Ç–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è üåê', callback_data='timezone_settings')],
            [InlineKeyboardButton('üö´ –í—ñ–¥–º—ñ–Ω–∏—Ç–∏', callback_data='cancel')]
        ])

        context.user_data['markup_msg'] = await city_changed_message.edit_text(city_change_text,
                                                                               reply_markup=approve_keyboard)
        return TIMEZONE_SETTINGS

    command_msg = context.user_data.get('command_msg')
    context.user_data.clear()
    context.user_data['command_msg'] = command_msg
    context.user_data['markup_msg'] = city_changed_message

    return SETTINGS_START


async def change_timezone_to_city(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    user = update.effective_user
    await query.answer()

    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        users_city_model = user_model.city
        timezone_offset = users_city_model.timezone_offset
        city_name = users_city_model.local_name
        await update_user(session, user, {'timezone_offset': timezone_offset})

    timezone_changed_text = (f'‚úÖ –ó—Ä–æ–±–ª–µ–Ω–æ, —Ç–≤—ñ–π —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å —Ç–µ–ø–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∫–∞–∑–∞–Ω–æ–º—É –º—ñ—Å—Ç—É '
                             f'{city_name} ({UserTime.offset_repr(timezone_offset)}).'
                             f'\n\n –©–æ—Å—å —â–µ?')
    await query.edit_message_text(text=timezone_changed_text, reply_markup=main_settings_keyboard)

    command_msg = context.user_data.get('command_msg')
    markup_msg = context.user_data.get('markup_msg')
    context.user_data.clear()
    context.user_data['command_msg'] = command_msg
    context.user_data['markup_msg'] = markup_msg

    return SETTINGS_START


async def timezone_settings_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    message = query.message
    user = update.effective_user
    markup_msg = context.user_data['markup_msg']

    await query.answer()
    if markup_msg:
        await markup_msg.edit_reply_markup(reply_markup=None)

    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        users_city_model = user_model.city

    timezone_change_text = ('üÜó –û–±—Ä–∞–Ω–æ –∑–º—ñ–Ω—É —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å—É.\n\n'
                            '–ü–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å—É:\n')
    if users_city_model:
        timezone_change_text += (f'{Config.SPACING}–£ –º—ñ—Å—Ç—ñ {users_city_model.local_name}: '
                                 f'{UserTime.offset_repr(users_city_model.timezone_offset)}\n')

    timezone_change_text += (f'{Config.SPACING}–í–∫–∞–∑–∞–Ω–∏–π –≤ –ø—Ä–æ—Ñ—ñ–ª—ñ: '
                             f'{UserTime.offset_repr(user_model.timezone_offset)}\n\n'
                             f'–î–ª—è –∑–º—ñ–Ω–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å—É –Ω–∞–¥—ñ—à–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ (–ü—Ä–∏–∫–ª–∞–¥: +3).')

    await message.edit_text(text=timezone_change_text, reply_markup=cancel_back_keyboard)

    return TIMEZONE_SETTINGS


@send_typing_action
async def user_timezone_change(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    message = update.message
    user = update.effective_user
    markup_msg = context.user_data['markup_msg']

    await markup_msg.edit_reply_markup(reply_markup=None)
    user_input = message.text.strip()

    if re.match(r'^[+|-]?[1-9][0-2]?$', user_input) and abs(int(user_input)) in range(1, 13):
        timezone_offset = int(user_input) * 3600
    else:
        timezone_change_error_text = '‚ö† C—Ö–æ–∂–µ —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å –≤–∫–∞–∑–∞–Ω–æ –Ω–µ –≤—ñ—Ä–Ω–æ, —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.'
        context.user_data['markup_msg'] = await message.reply_text(text=timezone_change_error_text,
                                                                   reply_markup=cancel_back_keyboard)
        return TIMEZONE_SETTINGS

    async with get_session() as session:
        await update_user(session, user, {'timezone_offset': timezone_offset})

    timezone_change_text = (f'‚úÖ –ó—Ä–æ–±–ª–µ–Ω–æ, —Ç–≤—ñ–π —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å —Ç–µ–ø–µ—Ä {UserTime.offset_repr(timezone_offset)}'
                            f'\n\n–©–æ—Å—å —â–µ?')
    markup_msg = await message.reply_text(text=timezone_change_text, reply_markup=main_settings_keyboard)

    command_msg = context.user_data.get('command_msg')
    context.user_data.clear()
    context.user_data['command_msg'] = command_msg
    context.user_data['markup_msg'] = markup_msg

    return SETTINGS_START


def compose_crypto_keyboard(data: list | None = None):
    data = [] if data is None else data

    btc = '‚òë' if 'BTC' in data else '‚ùå'
    eth = '‚òë' if 'ETH' in data else '‚ùå'
    bnb = '‚òë' if 'BNB' in data else '‚ùå'
    xrp = '‚òë' if 'XRP' in data else '‚ùå'
    doge = '‚òë' if 'DOGE' in data else '‚ùå'
    sol = '‚òë' if 'SOL' in data else '‚ùå'

    crypto_keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton(f'BTC {btc}', callback_data='BTC'),
            InlineKeyboardButton(f'ETH {eth}', callback_data='ETH'),
            InlineKeyboardButton(f'BNB {bnb}', callback_data='BNB'),
        ],
        [
            InlineKeyboardButton(f'XRP {xrp}', callback_data='XRP'),
            InlineKeyboardButton(f'DOGE {doge}', callback_data='DOGE'),
            InlineKeyboardButton(f'SOL {sol}', callback_data='SOL'),
        ],
        [InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='back')],
        [InlineKeyboardButton('üö´ –í—ñ–¥–º—ñ–Ω–∏—Ç–∏', callback_data='cancel')]
    ])

    return crypto_keyboard


async def crypto_settings_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    user = update.effective_user
    message = query.message
    context.user_data['markup_msg'] = message.message_id

    await query.answer()

    crypto_change_text = ('üÜó –û–±—Ä–∞–Ω–æ –∑–º—ñ–Ω—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.\n\n–ú–µ–Ω–µ–¥–∂–µ–º–µ–Ω—Ç –∫—Ä–∏–ø—Ç–æ—é –º–æ–∂–µ—à –ø—Ä–æ–≤–æ–¥–∏—Ç–∏ –Ω–∏–∂—á–µ,'
                          ' —â–æ–± –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É.')

    async with get_session() as session:
        if crypto_models := await get_crypto_by_user_id(session, user.id):
            data = [model.abbr for model in crypto_models]
        else:
            data = []

    crypto_keyboard = compose_crypto_keyboard(data)

    context.user_data['markup_msg'] = await message.edit_text(text=crypto_change_text, reply_markup=crypto_keyboard)
    context.user_data['crypto_data'] = data

    return CRYPTO_SETTINGS


async def user_crypto_change(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    message = query.message
    user = update.effective_user
    user_choice = query.data
    data = context.user_data['crypto_data']

    await query.answer()
    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        model = await get_crypto_by_abbr(session, user_choice)

        if user_choice in data:
            data.remove(user_choice)
            user_model.crypto_currency.remove(model)
        else:
            data.extend([user_choice])
            user_model.crypto_currency.append(model)

        await session.commit()

    crypto_keyboard = compose_crypto_keyboard(data)
    await message.edit_reply_markup(crypto_keyboard)

    context.user_data['crypto_data'] = data

    return CRYPTO_SETTINGS


def compose_curr_keyboard(data: list | None = None):
    data = [] if data is None else data

    usd = '‚òë' if 'usd' in data else '‚ùå'
    eur = '‚òë' if 'eur' in data else '‚ùå'
    pln = '‚òë' if 'pln' in data else '‚ùå'
    gbp = '‚òë' if 'gbp' in data else '‚ùå'

    curr_keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton(f'USD {usd}', callback_data='usd'),
            InlineKeyboardButton(f'EUR {eur}', callback_data='eur'),
            InlineKeyboardButton(f'PLN {pln}', callback_data='pln'),
            InlineKeyboardButton(f'GBP {gbp}', callback_data='gbp'),
        ],
        [InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='back')],
        [InlineKeyboardButton('üö´ –í—ñ–¥–º—ñ–Ω–∏—Ç–∏', callback_data='cancel')]
    ])

    return curr_keyboard


async def curr_settings_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    user = update.effective_user
    message = query.message
    context.user_data['markup_msg'] = message.message_id

    await query.answer()

    curr_change_text = ('üÜó –û–±—Ä–∞–Ω–æ –∑–º—ñ–Ω—É –≤–∞–ª—é—Ç.\n\n–ú–µ–Ω–µ–¥–∂–µ–º–µ–Ω—Ç –≤–∞–ª—é—Ç–∞–º–∏ –º–æ–∂–µ—à –ø—Ä–æ–≤–æ–¥–∏—Ç–∏ –Ω–∏–∂—á–µ, '
                        '—â–æ–± –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É.')

    async with get_session() as session:
        if curr_models := await get_curr_by_user_id(session, user.id):
            data = [model.name for model in curr_models]
        else:
            data = []

    curr_keyboard = compose_curr_keyboard(data)

    context.user_data['markup_msg'] = await message.edit_text(text=curr_change_text, reply_markup=curr_keyboard)
    context.user_data['curr_data'] = data

    return CURR_SETTINGS


async def user_curr_change(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    message = query.message
    user = update.effective_user
    user_choice = query.data
    data = context.user_data['curr_data']

    await query.answer()
    async with get_session() as session:
        user_model = await get_user_by_id(session, user.id)
        model = await get_curr_by_name(session, user_choice)

        if user_choice in data:
            data.remove(user_choice)
            user_model.currency.remove(model)
        else:
            data.extend([user_choice])
            user_model.currency.append(model)

        await session.commit()

    curr_keyboard = compose_curr_keyboard(data)
    await message.edit_reply_markup(curr_keyboard)

    context.user_data['curr_data'] = data

    return CURR_SETTINGS


settings_conversation_handler = ConversationHandler(
    entry_points=[CommandHandler('settings', settings)],
    states={
        SETTINGS_START: [
            CallbackQueryHandler(cancel, pattern='^cancel$'),
            CallbackQueryHandler(city_settings_start, pattern='^city_settings$'),
            CallbackQueryHandler(timezone_settings_start, pattern='^timezone_settings$'),
            CallbackQueryHandler(crypto_settings_start, pattern='^crypto_settings$'),
            CallbackQueryHandler(curr_settings_start, pattern='^curr_settings$')
        ],
        CITY_SETTINGS: [
            CallbackQueryHandler(cancel, pattern='^cancel$'),
            CallbackQueryHandler(back_to_settings, pattern='^back$'),
            MessageHandler(filters.TEXT, city_settings_change)
        ],
        TIMEZONE_SETTINGS: [
            CallbackQueryHandler(cancel, pattern='^cancel$'),
            CallbackQueryHandler(back_to_settings, pattern='^back$'),
            CallbackQueryHandler(change_timezone_to_city, pattern='^change_to_city$'),
            CallbackQueryHandler(timezone_settings_start, pattern='^timezone_settings$'),
            MessageHandler(filters.TEXT, user_timezone_change)
        ],
        CRYPTO_SETTINGS: [
            CallbackQueryHandler(cancel, pattern='^cancel$'),
            CallbackQueryHandler(back_to_settings, pattern='^back$'),
            CallbackQueryHandler(user_crypto_change, pattern=r'\w')
        ],
        CURR_SETTINGS: [
            CallbackQueryHandler(cancel, pattern='^cancel$'),
            CallbackQueryHandler(back_to_settings, pattern='^back$'),
            CallbackQueryHandler(user_curr_change, pattern=r'\w')
        ]
    },
    fallbacks=[
        MessageHandler(filters.ALL & filters.COMMAND, cancel)
    ],
    conversation_timeout=300.0
)
